# =============================================================================
# Trading System Configuration
# =============================================================================
# Version: 2.0
# Description: Centralized configuration for fund allocation and bot strategies
# =============================================================================

# -----------------------------------------------------------------------------
# System Settings
# -----------------------------------------------------------------------------
system:
  # Interval in seconds to check for balance changes
  poll_interval: 60

  # Minimum amount to trigger allocation (avoid small amounts)
  min_allocation_unit: 10.0

  # Reserved funds - minimum balance to keep in pool (not for allocation)
  reserve_amount: 100.0

  # Reserve ratio - percentage of total funds to keep in reserve (0.0 - 1.0)
  reserve_ratio: 0.1

  # Log level: DEBUG, INFO, WARNING, ERROR, CRITICAL
  log_level: INFO

  # Data storage path for SQLite database
  data_path: data/fund_manager.db

  # Notification output directory for file-based notifications
  notification_path: data/fund_notifications/

# -----------------------------------------------------------------------------
# Exchange Settings
# -----------------------------------------------------------------------------
exchange:
  # Exchange name: binance, okx, bybit, etc.
  name: binance

  # Currency to monitor for balance
  base_currency: USDT

  # Market type: spot, futures
  market_type: futures

# -----------------------------------------------------------------------------
# Allocation Strategy
# -----------------------------------------------------------------------------
strategy:
  # Strategy type: fixed_ratio, fixed_amount, dynamic_weight
  type: fixed_ratio

  # Auto dispatch when deposit detected
  auto_dispatch: true

  # Delay in seconds after detecting new funds before dispatching
  new_fund_delay: 30

  # Rebalance frequency: daily, weekly, monthly, never
  rebalance_frequency: weekly

  # Day for weekly rebalance (0=Monday, 6=Sunday)
  rebalance_day: 0

  # Hour for rebalance (24-hour format)
  rebalance_hour: 0

# -----------------------------------------------------------------------------
# Bot Configurations
# -----------------------------------------------------------------------------
# Each bot includes:
#   - Fund allocation settings (ratio, min/max capital)
#   - Strategy parameters (Walk-Forward validated)
# -----------------------------------------------------------------------------
bots:

  # ===========================================================================
  # Bollinger Bot (BB_NEUTRAL_GRID 策略: 雙向中性網格交易)
  # ===========================================================================
  # WF v4 Optuna 300 trials (2026-02-01, use_margin fix):
  # - 一致性 100% (9/9 折獲利), 平均 Sharpe: 4.73
  # - 平均報酬: +242.2%, 總交易: 6,749
  # - 18x 槓桿
  # ===========================================================================
  - bot_id: bollinger_*
    name: "Bollinger BB_NEUTRAL_GRID Strategy"
    status: active

    # --- 資金分配 ---
    ratio: 0.25                          # 25%
    min_capital: 50
    max_capital: 8000
    priority: 9

    # --- 策略參數 (WF v4 Optuna 300 trials, use_margin fix, 2026-02-01) ---
    strategy_params:
      symbol: BTCUSDT
      timeframe: 1h
      leverage: 18                        # 18x
      margin_type: ISOLATED
      position_size_pct: 0.05             # 5% (18x×5%×25%=22.5% < 30% pre-trade limit)
      max_position_pct: 0.5

      # Strategy Mode
      mode: bb_neutral_grid               # 雙向中性網格

      # Bollinger Bands (用於參考，不作為趨勢過濾)
      bb_period: 21                       # WF v5 優化: 21
      bb_std: 2.0

      # Grid Parameters (WF v5 2026-02-01)
      grid_count: 10                      # WF v5 優化: 10
      take_profit_grids: 1                # WF v5 優化: 1

      # ATR Dynamic Range (WF v5 2026-02-01)
      use_atr_range: true                 # 啟用 ATR 動態範圍
      atr_period: 13                      # WF v5 優化: 13
      atr_multiplier: 6.5                 # WF v5 優化: 6.5
      fallback_range_pct: 0.04            # ATR 不可用時的備用範圍

      # Risk Management (WF v5 2026-02-01)
      stop_loss_pct: 0.002                # WF v5 優化: 0.2%
      rebuild_threshold_pct: 0.02

      # BBW Filter (壓縮偵測)
      bbw_lookback: 200
      bbw_threshold_pct: 20

      # Protective Features (WF v5 2026-02-01)
      use_hysteresis: true                # WF v5 優化: 開啟
      hysteresis_pct: 0.003               # WF v5 優化: 0.3%
      use_signal_cooldown: false          # WF v5 優化: 關閉
      cooldown_bars: 1                    # WF v5 優化: 1

      # Exchange Stop Loss (STOP_MARKET on exchange)
      use_exchange_stop_loss: true

      # Timeout Exit (0 = disabled)
      max_hold_bars: 0                    # 停用 (可設 8-20 啟用)

  # ===========================================================================
  # RSI-Grid Hybrid Bot (RSI 區域 + 網格進場)
  # ===========================================================================
  # 參數優化 (2026-01-27) + Walk-Forward 驗證:
  # - 年化報酬: 5.59%, Sharpe: 6.51, 回撤: 0.94%
  # - W-F 一致性: 50%, Monte Carlo: ROBUST (100% 獲利)
  # - 勝率: 84.8%, 交易數: 328/2年
  # ===========================================================================
  - bot_id: rsi_grid_*
    name: "RSI-Grid Hybrid Strategy"
    status: active

    # --- 資金分配 ---
    ratio: 0.10                          # 10% (優化後調整)
    min_capital: 50
    max_capital: 5000
    priority: 8

    # --- 策略參數 (v4 Optuna 優化 2026-02-01) ---
    # Optuna 100 trials, fixed 5% position sizing, 10x leverage
    # Train Sharpe: 2.47, Test Sharpe: 3.20, OOS/IS: 1.30
    # 完整回測: Sharpe 3.08, 報酬 142.67%, 年化 55.78%, 回撤 7.48%
    # WF 驗證: 一致性 66.7%, OOS Sharpe 2.51, Monte Carlo ROBUST
    strategy_params:
      symbol: BTCUSDT
      timeframe: 1h
      leverage: 10
      margin_type: ISOLATED
      position_size_pct: 0.05
      max_position_pct: 0.5

      # RSI Parameters (v4 Optuna 優化)
      rsi_period: 7
      rsi_block_threshold: 0.9
      oversold_level: 33
      overbought_level: 66

      # Grid Parameters (v4 Optuna 優化)
      grid_count: 8
      atr_period: 7
      atr_multiplier: 3.0

      # Risk Management (v4 Optuna 優化)
      stop_loss_atr_mult: 1.5
      take_profit_grids: 2
      max_hold_bars: 6

      # Trailing Stop (v4: 關閉)
      use_trailing_stop: false
      trailing_stop_pct: 0.01

      # Volatility Regime Filter (v4 Optuna 優化)
      use_volatility_filter: true
      vol_atr_baseline_period: 200
      vol_ratio_low: 0.5
      vol_ratio_high: 2.0

  # ===========================================================================
  # Grid Futures Bot (雙向網格策略)
  # ===========================================================================
  # Optuna 300 trials, fixed Sharpe MTM (2026-02-01):
  # - OOS 報酬: +188.2%, OOS Sharpe: 5.57, OOS 回撤: 2.76%
  # - W-F 一致性: 100% (9/9), OOS/IS Sharpe: 1.08
  # - Monte Carlo 獲利機率: 100%, 破產機率: 0%
  # - 無過度擬合 (avg OOS Sharpe 7.91)
  # ===========================================================================
  - bot_id: grid_futures_*
    name: "Grid Futures Trading"
    status: active

    # --- 資金分配 ---
    ratio: 0.40                          # 40% (主力策略)
    min_capital: 100
    max_capital: 10000
    priority: 10

    # --- 策略參數 (Optuna 300 trials, fixed Sharpe MTM 2026-02-01) ---
    # IS: +7222%, OOS: +188.2%, OOS Sharpe: 5.57, WF 100% (9/9)
    strategy_params:
      symbol: BTCUSDT
      timeframe: 1h
      leverage: 7                        # 7x (equity-based margin)
      margin_type: ISOLATED
      position_size_pct: 0.1
      max_position_pct: 0.5

      # Grid Settings (Optuna v2 優化)
      grid_count: 8                      # 優化結果: 8 (原 12)
      direction: neutral                 # NEUTRAL (雙向交易)

      # Trend Filter
      use_trend_filter: false
      trend_period: 48                   # 優化結果: 48 (原 27)

      # ATR Range (優化後)
      use_atr_range: true
      atr_period: 46                     # 優化結果: 46 (原 41)
      atr_multiplier: 6.5                # 優化結果: 6.5 (原 10.0)
      fallback_range_pct: 0.08

      # Take Profit
      take_profit_grids: 1               # 優化結果: 1

      # Risk Management (優化後)
      stop_loss_pct: 0.005               # 0.5% 緊止損 (優化結果)
      rebuild_threshold_pct: 0.02

      # Protective Features (優化後)
      use_hysteresis: true               # 優化結果: 啟用 (原 false)
      hysteresis_pct: 0.001              # 優化結果: 0.1% (原 0.5%)
      use_signal_cooldown: true          # 優化結果: 啟用 (原 false)
      cooldown_bars: 0                   # 優化結果: 0 (原 2)

      # Timeout Exit (0 = disabled)
      max_hold_bars: 0                    # 停用 (可設 8-20 啟用)

  # ===========================================================================
  # Supertrend HYBRID_GRID Bot (超級趨勢 + 雙向網格 + 趨勢偏移)
  # ===========================================================================
  # Optuna 300 trials, 10x, fixed 2% sizing (2026-02-01):
  # - IS: +61.6%, OOS: +25.8%, OOS Sharpe: 5.60
  # - OOS 回撤: 3.61%, 交易: 925 (OOS)
  # - 10x 槓桿, 固定倉位 2%, 無複利
  # ===========================================================================
  - bot_id: supertrend_*
    name: "Supertrend HYBRID_GRID Strategy"
    status: active

    # --- 資金分配 ---
    ratio: 0.15                          # 15%
    min_capital: 100
    max_capital: 5000
    priority: 7

    # --- 策略參數 (Optuna 300 trials, 10x, fixed sizing 2%, 2026-02-01) ---
    # IS: +61.6%, OOS: +25.8%, OOS Sharpe: 5.60, OOS 回撤: 3.61%
    strategy_params:
      symbol: BTCUSDT
      timeframe: 1h
      leverage: 10                       # 10x (Optuna 優化 2026-02-01)
      margin_type: ISOLATED
      position_size_pct: 0.02            # 2% fixed sizing (no compounding)

      # Strategy Mode
      mode: hybrid_grid                  # 雙向交易 + 趨勢偏移

      # Supertrend Settings (2026-02-01 優化, fixed sizing)
      atr_period: 18                     # ATR 週期 (優化結果)
      atr_multiplier: 6.0               # ATR 乘數 (優化結果)

      # Grid Settings (HYBRID_GRID 模式)
      grid_count: 10                     # 網格數量 (優化結果)
      grid_atr_multiplier: 10.0          # 網格範圍 ATR 乘數 (優化結果)
      take_profit_grids: 1               # 止盈網格數

      # RSI Filter (優化後)
      use_rsi_filter: true
      rsi_period: 17                     # RSI 週期 (優化結果)
      rsi_overbought: 74                 # 優化結果: 74
      rsi_oversold: 25                   # 優化結果: 25

      # Trend confirmation
      min_trend_bars: 1

      # Risk Management (優化後)
      stop_loss_pct: 0.02                # 2% (優化結果)
      use_trailing_stop: true            # 啟用追蹤止損
      trailing_stop_pct: 0.01            # 1% (優化結果)

      # Protective Features (優化後: 均關閉)
      use_hysteresis: false
      hysteresis_pct: 0.0095             # 優化結果
      use_signal_cooldown: false
      cooldown_bars: 0                   # 優化結果: 0

      # Volatility Regime Filter (優化後: 關閉)
      use_volatility_filter: false
      vol_atr_baseline_period: 200
      vol_ratio_low: 0.7                 # 優化結果
      vol_ratio_high: 3.0                # 優化結果

      # Timeout Exit
      max_hold_bars: 32                  # 優化結果: 32

      # HYBRID_GRID Specific (優化後)
      hybrid_grid_bias_pct: 0.55         # 優化結果: 0.55
      hybrid_tp_multiplier_trend: 1.0    # 順勢 TP 倍數
      hybrid_tp_multiplier_counter: 0.75 # 逆勢 TP 倍數
      hybrid_sl_multiplier_counter: 0.8  # 優化結果: 0.8
      hybrid_rsi_asymmetric: false       # RSI 非對稱過濾: 關閉

# Total: 90% allocated (Grid Futures 40% + Bollinger 25% + Supertrend 15% + RSI-Grid 10%), 10% reserve
# 預估組合年化報酬: ~40-50%
#   - Grid Futures (40%): OOS +188.2%, Sharpe 5.57, WF 100% (7x, fixed Sharpe 2026-02-01)
#   - Bollinger NEUTRAL (25%): WF 100% (9/9), avg Sharpe 4.73 (18x, WF v4 use_margin fix 2026-02-01)
#   - Supertrend HYBRID_GRID (15%): OOS +25.8%, Sharpe 5.60 (10x, fixed 2% 2026-02-01)
#   - RSI-Grid (10%): 12.09% 年化 (v2 vol filter 2026-01-30)
# 槓桿配置 - Grid/RSI 7x, Supertrend 10x, Bollinger 18x (equity-based margin)

# -----------------------------------------------------------------------------
# Signal Coordinator Settings (多機器人訊號協調)
# -----------------------------------------------------------------------------
signal_coordinator:
  # Conflict resolution strategy:
  # - block_newer: Block the newer conflicting signal (default)
  # - block_smaller: Block signal with smaller size
  # - warn_only: Log warning but allow both
  # - allow_hedge: Allow hedging (both long and short)
  # - priority_based: Use bot priority to decide
  resolution: allow_hedge

  # Signal time-to-live in seconds
  signal_ttl_seconds: 60

  # Symbols that allow hedging (opposite direction positions)
  # 允許對沖的交易對 - 這些交易對可以同時持有多空倉位
  allowed_hedge_symbols:
    - BTCUSDT

  # Bot priorities (higher = more important, used with priority_based resolution)
  bot_priorities:
    grid_futures: 10
    bollinger: 9
    rsi_grid: 8
    supertrend: 7

# -----------------------------------------------------------------------------
# Notification Settings
# -----------------------------------------------------------------------------
notifications:
  enabled: true
  retry_count: 3
  retry_interval: 60
  events:
    - deposit_detected
    - allocation_complete
    - allocation_failed
    - rebalance_complete

# -----------------------------------------------------------------------------
# Safety Limits
# -----------------------------------------------------------------------------
limits:
  max_single_allocation: 5000
  max_daily_allocation: 20000
  balance_drop_alert_threshold: 0.20
  confirm_threshold: 1000
