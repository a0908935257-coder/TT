# =============================================================================
# Trading System Configuration
# =============================================================================
# Version: 2.0
# Description: Centralized configuration for fund allocation and bot strategies
# =============================================================================

# -----------------------------------------------------------------------------
# System Settings
# -----------------------------------------------------------------------------
system:
  # Interval in seconds to check for balance changes
  poll_interval: 60

  # Minimum amount to trigger allocation (avoid small amounts)
  min_allocation_unit: 10.0

  # Reserved funds - minimum balance to keep in pool (not for allocation)
  reserve_amount: 100.0

  # Reserve ratio - percentage of total funds to keep in reserve (0.0 - 1.0)
  reserve_ratio: 0.1

  # Log level: DEBUG, INFO, WARNING, ERROR, CRITICAL
  log_level: INFO

  # Data storage path for SQLite database
  data_path: data/fund_manager.db

  # Notification output directory for file-based notifications
  notification_path: data/fund_notifications/

# -----------------------------------------------------------------------------
# Exchange Settings
# -----------------------------------------------------------------------------
exchange:
  # Exchange name: binance, okx, bybit, etc.
  name: binance

  # Currency to monitor for balance
  base_currency: USDT

  # Market type: spot, futures
  market_type: futures

# -----------------------------------------------------------------------------
# Allocation Strategy
# -----------------------------------------------------------------------------
strategy:
  # Strategy type: fixed_ratio, fixed_amount, dynamic_weight
  type: fixed_ratio

  # Auto dispatch when deposit detected
  auto_dispatch: true

  # Delay in seconds after detecting new funds before dispatching
  new_fund_delay: 30

  # Rebalance frequency: daily, weekly, monthly, never
  rebalance_frequency: weekly

  # Day for weekly rebalance (0=Monday, 6=Sunday)
  rebalance_day: 0

  # Hour for rebalance (24-hour format)
  rebalance_hour: 0

# -----------------------------------------------------------------------------
# Bot Configurations
# -----------------------------------------------------------------------------
# Each bot includes:
#   - Fund allocation settings (ratio, min/max capital)
#   - Strategy parameters (Walk-Forward validated)
# -----------------------------------------------------------------------------
bots:

  # ===========================================================================
  # Bollinger Bot (BB_TREND_GRID 策略: BB 中軌趨勢 + 網格交易)
  # ===========================================================================
  # Walk-Forward 驗證: 80% 一致性 (8/10 時段獲利), OOS Sharpe 6.56
  # 平均 OOS 報酬: 10.39%, 穩健性: ROBUST
  # ===========================================================================
  - bot_id: bollinger_*
    name: "Bollinger BB_TREND_GRID Strategy"
    status: active

    # --- 資金分配 ---
    ratio: 0.30                          # 30%
    min_capital: 50
    max_capital: 8000
    priority: 9

    # --- 策略參數 (Walk-Forward validated) ---
    strategy_params:
      symbol: BTCUSDT
      timeframe: 1h                       # 優化後使用 1h
      leverage: 2
      margin_type: ISOLATED
      position_size_pct: 0.1
      max_position_pct: 0.5

      # Bollinger Bands (用於趨勢判斷)
      bb_period: 20
      bb_std: 2.0                         # 標準 2.0 (不是 3.0)

      # Grid Parameters (網格交易)
      grid_count: 10                      # 網格數量
      grid_range_pct: 0.04                # 4% 範圍
      take_profit_grids: 1                # 止盈網格數

      # Risk Management
      stop_loss_pct: 0.05                 # 5% 止損
      rebuild_threshold_pct: 0.02         # 2% 網格重建閾值

      # BBW Filter (壓縮偵測)
      bbw_lookback: 200
      bbw_threshold_pct: 20

      # Protective Features (disabled for maximum returns)
      # 回測顯示關閉可提升收益 1.45%，Sharpe 差異極小
      use_hysteresis: false              # 遲滯緩衝區 (已禁用)
      hysteresis_pct: 0.002              # 0.2% (如需啟用)
      use_signal_cooldown: false         # 訊號冷卻 (已禁用)
      cooldown_bars: 2                   # 2 bars (如需啟用)

  # ===========================================================================
  # RSI-Grid Hybrid Bot (RSI 區域 + 網格進場)
  # ===========================================================================
  # 目標: Sharpe > 3.0, 一致性 > 90%, 勝率 > 70%
  # 結合 RSI 均值回歸 + Grid 高頻進場機制
  # ===========================================================================
  - bot_id: rsi_grid_*
    name: "RSI-Grid Hybrid Strategy"
    status: active

    # --- 資金分配 ---
    ratio: 0.15                          # 15% (取代 RSI Momentum)
    min_capital: 50
    max_capital: 5000
    priority: 8

    # --- 策略參數 ---
    strategy_params:
      symbol: BTCUSDT
      timeframe: 15m
      leverage: 2
      margin_type: ISOLATED
      position_size_pct: 0.1
      max_position_pct: 0.5

      # RSI Parameters
      rsi_period: 14
      oversold_level: 30
      overbought_level: 70

      # Grid Parameters
      grid_count: 10
      atr_period: 14
      atr_multiplier: 3.0

      # Trend Filter
      trend_sma_period: 20
      use_trend_filter: true

      # Risk Management
      stop_loss_atr_mult: 1.5
      max_stop_loss_pct: 0.03            # 3%
      take_profit_grids: 1
      max_positions: 5

      # Protective Features (disabled based on backtest results)
      # 回測顯示這些保護機制對 RSI Grid 策略有負面影響
      use_hysteresis: false              # 遲滯緩衝區 (已禁用)
      hysteresis_pct: 0.002              # 0.2% (如需啟用)
      use_signal_cooldown: false         # 訊號冷卻 (已禁用)
      cooldown_bars: 2                   # 2 bars (如需啟用)

  # ===========================================================================
  # Grid Futures Bot (雙向網格策略)
  # ===========================================================================
  # Walk-Forward 驗證: 100% 一致性, Sharpe 8.33
  # 報酬: +376.5% (2年), 勝率: 83.6%, 交易: 1,891 次
  # 參數: leverage=10, direction=NEUTRAL (與回測完全一致)
  # ===========================================================================
  - bot_id: grid_futures_*
    name: "Grid Futures Trading"
    status: active

    # --- 資金分配 ---
    ratio: 0.30                          # 30%
    min_capital: 100
    max_capital: 10000
    priority: 10

    # --- 策略參數 (與回測完全一致) ---
    strategy_params:
      symbol: BTCUSDT
      timeframe: 1h
      leverage: 10                       # 回測驗證: 10x
      margin_type: ISOLATED
      position_size_pct: 0.1
      max_position_pct: 0.5

      # Grid Settings
      grid_count: 10
      direction: neutral                 # 回測驗證: NEUTRAL (雙向交易)

      # Trend Filter (NEUTRAL 模式不使用趨勢過濾)
      use_trend_filter: false
      trend_period: 20

      # ATR Range
      use_atr_range: true
      atr_period: 14
      atr_multiplier: 3.0
      fallback_range_pct: 0.08

      # Risk Management
      stop_loss_pct: 0.05
      rebuild_threshold_pct: 0.02

      # Protective Features (ENABLED based on backtest results)
      # 回測顯示啟用可提升收益 8.76%，Sharpe +0.06，回撤降低 15.78%
      use_hysteresis: true               # 遲滯緩衝區 (已啟用，改善表現)
      hysteresis_pct: 0.002              # 0.2%
      use_signal_cooldown: true          # 訊號冷卻 (已啟用，改善表現)
      cooldown_bars: 2                   # 2 bars

  # ===========================================================================
  # Supertrend TREND_GRID Bot (超級趨勢 + 網格 + RSI 過濾策略)
  # ===========================================================================
  # 參數優化 (2026-01-27) + Walk-Forward 驗證:
  # - 年化報酬: 8.69%, Sharpe: 3.78, 回撤: 4.51%
  # - 一致性: 30% (3/10), 穩健性: ROBUST (Monte Carlo 100%)
  # - 勝率: 85.4%, 總交易: 540 筆/2年
  # ===========================================================================
  - bot_id: supertrend_*
    name: "Supertrend GRID Strategy"
    status: active

    # --- 資金分配 ---
    ratio: 0.15                          # 15%
    min_capital: 100
    max_capital: 5000
    priority: 7

    # --- 策略參數 (Optuna 優化 2026-01-27) ---
    strategy_params:
      symbol: BTCUSDT
      timeframe: 1h
      leverage: 2
      margin_type: ISOLATED
      position_size_pct: 0.1

      # Supertrend Settings (優化後)
      atr_period: 46                     # ATR 週期 (原 14 → 46)
      atr_multiplier: 2.5                # ATR 乘數 (原 3.0 → 2.5)

      # Grid Settings (TREND_GRID 模式，優化後)
      grid_count: 8                      # 網格數量 (原 10 → 8)
      grid_atr_multiplier: 5.0           # 網格範圍 ATR 乘數 (原 3.0 → 5.0)
      take_profit_grids: 1               # 止盈網格數

      # RSI Filter (優化後)
      use_rsi_filter: true
      rsi_period: 18                     # RSI 週期 (原 14 → 18)
      rsi_overbought: 62                 # RSI > 62 不做多 (原 60 → 62)
      rsi_oversold: 31                   # RSI < 31 不做空 (原 40 → 31)

      # Trend confirmation (優化後)
      min_trend_bars: 3                  # 趨勢確認 K 線數 (原 2 → 3)

      # Risk Management (優化後)
      stop_loss_pct: 0.04                # 4% (原 5% → 4%)
      use_trailing_stop: true            # 啟用追蹤止損
      trailing_stop_pct: 0.03            # 3% (原 2% → 3%)

      # Protective Features (與實戰一致，優化後)
      use_hysteresis: true               # 遲滯緩衝區 (已啟用)
      hysteresis_pct: 0.004              # 0.4% (原 0.2% → 0.4%)
      use_signal_cooldown: true          # 訊號冷卻 (已啟用)
      cooldown_bars: 4                   # 4 bars (原 2 → 4)

# Total: 90% allocated, 10% reserve (unallocated)

# -----------------------------------------------------------------------------
# Signal Coordinator Settings (多機器人訊號協調)
# -----------------------------------------------------------------------------
signal_coordinator:
  # Conflict resolution strategy:
  # - block_newer: Block the newer conflicting signal (default)
  # - block_smaller: Block signal with smaller size
  # - warn_only: Log warning but allow both
  # - allow_hedge: Allow hedging (both long and short)
  # - priority_based: Use bot priority to decide
  resolution: allow_hedge

  # Signal time-to-live in seconds
  signal_ttl_seconds: 60

  # Symbols that allow hedging (opposite direction positions)
  # 允許對沖的交易對 - 這些交易對可以同時持有多空倉位
  allowed_hedge_symbols:
    - BTCUSDT

  # Bot priorities (higher = more important, used with priority_based resolution)
  bot_priorities:
    grid_futures: 10
    bollinger: 9
    rsi_grid: 8
    supertrend: 7

# -----------------------------------------------------------------------------
# Notification Settings
# -----------------------------------------------------------------------------
notifications:
  enabled: true
  retry_count: 3
  retry_interval: 60
  events:
    - deposit_detected
    - allocation_complete
    - allocation_failed
    - rebalance_complete

# -----------------------------------------------------------------------------
# Safety Limits
# -----------------------------------------------------------------------------
limits:
  max_single_allocation: 5000
  max_daily_allocation: 20000
  balance_drop_alert_threshold: 0.20
  confirm_threshold: 1000
